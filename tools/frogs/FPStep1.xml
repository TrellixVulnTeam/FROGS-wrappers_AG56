<?xml version="1.0"?>
<!--
# Copyright (C) 2015 INRA
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<tool id="FROGS_PICRUSt2_place_seqs" name="FPStep1" version= "beta">
	<description>Place studies sequences (i.e. OTUs) into a reference tree.</description>

    <macros>
        <import>macros.xml</import>
    </macros>

<!--      <expand macro="requirements_frogsfunc">
        <requirement type="package" version="3.1.2">ete3</requirement>
    </expand>-->

    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>
    <command >
	   	FPStep1.py
	   		--input-fasta $input_fasta
	   		--input-biom $input_biom
	   		--min-align $min_align
	   		--placement-tool $placement_tool
	   		--out-tree $out_tree 
	   		--excluded $excluded
	   		--insert-biom $insert_biom
	   		--insert-fasta $insert_fasta
	   		--closests-ref $closests_ref
	   		--html $summary_file
	   		--debug

	   		#if $marker.name != "16S"
	   		--ref-dir ${marker.value}
	   		#end if
	</command> 
	<inputs>
    	<!-- Input files -->
		<param format="fasta" name="input_fasta" type="data" label="Sequence file" help="Fasta file of unaligned studies sequences (format: fasta)." optional="false">
       		<validator type="empty_field" message="This parameter is required." />
    	</param>
		<param format="biom1" name="input_biom" type="data" label="Biom file" help="Abundance table of OTUs (format: biom). Taxonomic affiliations must be done before (FROGS Affiliation OTU step)." optional="false">
        	<validator type="empty_field" message="This parameter is required." />
        </param>
    	<!-- Parameters -->
        <param name="marker" type="select" label="Taxonomy marker" display="radio" help="Taxonomic marker of interest.">
			<options from_data_table="frogs_picrust2_default_dir">
	     		<column name="name" index="1"/>
	        	<column name="value" index="2"/>
					<validator type="no_options" message="A built-in database is not available" />
			</options>
		</param>
        <param name="placement_tool" type="select" label="Placement tool" help="Placement tool for insertion of OTUs (or ASVs) into the reference tree. SEPP is a low-memory alternative to EPA-ng for placing sequences." multiple="false" display="radio">
        	<option value="epa-ng">epa-ng</option>
        	<option value="sepp">sepp</option>
		</param>
		<param name="min_align" type="float" label="Minimum alignment length" help="Proportion of the total length of an input query sequence that must align with reference sequences. Any sequences with lengths below this value after making an alignment with reference sequences will be excluded from the placement and all subsequent steps. (default: 0.80)" value="0.8" min="0" max="1" optional="false" /> 
	</inputs>

	<outputs>
		<data format="html" name="summary_file" label="${tool.name}: FPStep1_summary.html" from_work_dir="FPStep1_summary.html"/>
		<data format="nhx" name="out_tree" label="${tool.name}: FPStep1_tree.nwk" from_work_dir="FPStep1_tree.nwk"/>
		<data format="tabular" name="excluded" label="${tool.name}: FPStep1_excluded.tsv" from_work_dir="FPStep1_excluded.tsv"/> 
		<data format="fasta" name="insert_fasta" label="${tool.name}: FPStep1.fasta" from_work_dir="FPSTep1.fasta"/>
		<data format="tabular" name="closests_ref" label="${tool.name}: FPStep1_closests_ref_sequences.txt" from_work_dir="FPStep1_closests_ref_sequences.txt"/> 
		<data format="biom1" name="insert_biom" label="${tool.name}: FPStep1.biom" from_work_dir="FPSTep1.biom"/> 
	</outputs>

	<tests>
		<test>
			<param name="input_fasta" value="input/FPSteps.fasta" />
            <param name="input_biom" value="input/FPSteps.biom" />
            <param name="placement_tool" value="sepp"/>
			<param name="marker" value="16S" />
			<param name="min_align" value="0.8" />
			
			<output name="insert_fasta" file="references/25-FPStep1.fasta" compare="diff" lines_diff="0" />
			<output name="insert_biom" file="references/25-FPStep1.biom" compare="diff" lines_diff="0"/>
			<output name="excluded" file="references/25-FPStep1_excluded.txt" compare="diff" lines_diff="0" />
			<output name="out_tree" file="references/25-FPStep1.tree" compare="diff" lines_diff="0" />
			<output name="closests_ref" file="references/25-FPStep1_closests_ref_sequences.txt" compare="diff" lines_diff="0" />
			<output name="summary_file" file="references/25-FPStep1_summary.html" compare="diff" lines_diff="0" />
		</test>
	</tests>

     <help>

@HELP_LOGO@

.. class:: infomark page-header h2

What it does

Prediction of functional abundances based solely on the sequences of marker genes with `PICRUSt2 &lt;https://github.com/picrust/picrust2&gt;`_. The available marker genes are 16S, ITS and 18S.

.. class:: infomark page-header h2

Context

The first step of Picrust2 consists in placing the nucleotide sequences of the OTUs constructed elsewhere in a reference phylogenetic tree. 
The phylogenetic placement is done with `HMMER &lt;http://hmmer.org&gt;`_ to place study sequences into a reference multiple-sequence alignment  (`EPA_NG &lt;https://github.com/Pbdas/epa-ng#build-instructions&gt;`_ or `SEPP &lt;https://github.com/smirarab/sepp&gt;`_) to places these sequences into the reference phylogeny and product finaly tree with `GAPPA &lt;https://github.com/lczech/gappa&gt;`_.


.. class:: infomark page-header h2

Inputs/Outputs

.. class:: h3

Input


**Sequence file** (format `FASTA &lt;https://en.wikipedia.org/wiki/FASTA_format&gt;`_):

 The OTUs fasta sequence file.

**Biom file** (format `biom1 &lt;http://biom-format.org/documentation/format_versions/biom-1.0.html&gt;`_):


 The OTUs biom file. Taxonomic affiliations must be done before (FROGS Affiliation OTU step).


**Placement tool** 
 
 EPA-NG or SEPP. SEPP is a low-memory alternative to EPA-ng for placing sequences. 

.. image:: static/images/icon_warning_sml.gif 

So, if the tool crashes with EPA-ng, try SEPP.

.. class:: h3

Outputs

**Newick file** (FPStep1_tree.nwk):

 The phylogenetic tree output with insert sequences into the reference tree (format: newick). (format `nhx &lt;https://en.wikipedia.org/wiki/Newick_format&gt;`_).


**Excluded sequences file** (FPStep1_excluded.tsv):

 List of sequences not inserted in the picrust2 reference tree. Sequences are excluded if the total length of the input sequence aligned against reference sequence is less than the specified " Minimum alignment length " threshold (0.8 per default). These sequences are excluded for the next steps.

**Closests reference sequences file** (FPStep1_closests_ref_sequences.txt):

 Informations about closests reference sequences from studies sequences (i.e. OTUs).

**FPStep1 fasta file**

 OTUs sequence file without non insert sequences. (FPStep1.fasta)

**FPStep1 biom file**

 OTUs biom file without non insert sequences. (FPStep1.biom)

**Summary file** (FPStep1_summary.html):
   
 The summary file describing which OTUs are contained or not in the phylogenetic tree. Note that picrust2 uses its own reference tree to affiliate OTUs from reference sequences. The summary file indicates for each OTU which is the closest picrust2 reference sequence, and compares it to the FROGS taxonomy. Clicking on the sequence ID give you more information about it (`JGI database &lt;https://img.jgi.doe.gov/&gt;`_).

.. image:: static/images/FROGS_FPStep1_piecharts.png
	:height: 290
	:width: 676


The pie charts describe the proportion of number of OTUs excluded and the proportion of total sequences excluded for the following steps.
OTUs are excluded if the total length of the input sequence aligned against reference sequence is less than the specified " Minimum alignment length " threshold.

.. class:: h3

Result table

.. image:: static/images/FROGS_FPStep1_table.png


* **Cluster** : Cluster name.

* **FROGS Taxonomy** : Taxonomic affiliation made with FROGS (FROGS Affiliation OTU).

* **Picrust2 Closest ID** : Identifiant (JGI) of the closest reference sequence from the OTU inserted in the reference tree (see the explanatory illustration at the bottom of the help page).
 
* **Picrust2 closest reference name** : Genome Name / Sample Name.

* **Picrust2 closest taxonomy** : Taxonomy (JGI) of the closest reference sequence from the OTU inserted in the reference tree under the following format: Kingdom;Phylum;Class;Order;Family;Genus;Species

* **Picrust2 closest distance from cluster (NSTI)** : Nearest Sequenced Taxon Index (NSTI) is the phylogenetic distance between the OTU and the nearest sequenced reference genome. This metric can be used to identify OTUs that are highly distant from all reference sequences (the predictions for these sequences are less reliable!). The higher the NSTI score, the less the affiliations are relevant. Any OTUs with a NSTI value higher than 2 are typically either from uncharacterized phyla or off-target sequences.

* **Lowest same taxonomic rank between FROGS and Picrust2** : Comparison between FROGS and Picrust2 taxonomic affiliations.

* **Comment** : " identical taxonomy " if the FROGS and Picrus2 taxonomic affiliations are identical. " identical sequence " if the OTU sequence is the same as the reference sequence.

.. image:: static/images/FROGS_FPStep1_closest_explained.png

Closest reference sequence (from JGI database) from one cluster sequence.

@HELP_CONTACT@

	</help>

	<citations>
		<expand macro="citations" />
	</citations>
	
</tool>