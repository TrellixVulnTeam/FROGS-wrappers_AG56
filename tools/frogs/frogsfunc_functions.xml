<?xml version="1.0"?>
<!--
# Copyright (C) 2022 INRAE
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<tool id="FROGS_PICRUSt2_metagenome" name="frogsfunc_functions" version= "beta">
    <description>Predicting of functions weighted by the relative abundance of OTUs in the community. Inferring the metagenomes of the communities.</description>

    <macros>
        <import>macros.xml</import>
    </macros>

 <!--    <expand macro="requirements_frogsfunc" /> -->
    
    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>
    <command >
       frogsfunc_functions.py
            --input-biom $input_biom
            --function $function
            --marker $marker
            --max-nsti $max_nsti
            --min-reads $min_reads 
            --min-samples $min_samples
            --function-abund $function_abund
            --seqtab $seqtab
            --weighted $weighted
            --excluded $excluded
            #if $strat
                --strat-out
                --contrib $contrib
            #end if
            --html $summary_file
            --debug
    </command> 
    <inputs>
        <!-- Input files -->
        <param argument="--input-biom" format="biom1" name="input_biom" type="data" label="Biom file" help="The abundance file i.e. FROGSFUNC_step1_placeseqs tool output file (frogsfunc_placeseqs.biom)." optional="false">
            <validator type="empty_field" message="This parameter is required." />
        </param>
        <param argument='--function' format="tabular" type="data" label="Function file" help="Copy number table of functions present in the predicted genome for each OTU i.e. FROGSFUNC_step2_copynumbers tool output file (frogsfunc_copynumbers_predicted_functions.tsv)." optional="false">
            <validator type="empty_field" message="This parameter is required." />
        </param>
        <param argument='--marker' format="tabular" type="data" label="Marker file" help="Table of predicted marker copy number i.e. FROGSFUNC_step2_copynumbers output (frogsfunc_copynumbers_marker_copy_number.tsv)." optional="false">
            <validator type="empty_field" message="This parameter is required." />
        </param>
        <!-- Parameters-->
        <param argument="--max-nsti" name="max_nsti" type="float" label="NSTI cut-off" help="Any sequence with an NSTI above this threshold will be out. (default: 2)" value="2" min="0" optional="false" /> 
        <conditional name="is_strat">
            <param name="strat" type="boolean" label="Do you want a stratified table per sequence ?" help='Product another table of the predicted gene abundance contributed by each OTU. Note this will greatly increase the runtime.' />
            <when value="true">
                <param argument="--min-reads" name="min_reads" type="integer" optional="false" min="1" value="1" label="Minimum abundance to keep an OTU" help='All OTUs containing less than this minimum threshold of sequences will all be grouped in the "RARE" category. (default: 1).' />
                <param  argument="--min-samples" name="min_samples" type="integer" optional="false" min="1" value="1" label="Minimum number of samples to keep an OTU."  help='All OTUs present in less than this minimum sample threshold will be grouped in the RARE category. (default: 1).' />
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="html" name="summary_file" label="${tool.name}: frogsfunc_functions_summary.html" from_work_dir="frogsfunc_functions_summary.html"/>
        <data format="tabular" name="function_abund" label="${tool.name}: frogsfunc_functions_pred_metagenome_unstrat.tsv" from_work_dir="frogsfunc_functions_pred_metagenome_unstrat.tsv"/> 
        <data format="tabular" name="seqtab" label="${tool.name}: frogsfunc_functions_seqtab_norm.tsv" from_work_dir="frogsfunc_functions_seqtab_norm.tsv"/> 
        <data format="tabular" name="weighted" label="${tool.name}: frogsfunc_functions_weighted_nsti.tsv" from_work_dir="frogsfunc_functions_weighted_nsti.tsv"/> 
        <data format="tabular" name="excluded" label="${tool.name}: frogsfunc_functions_excluded.tsv" from_work_dir="frogsfunc_placeseqs_excluded.tsv"/> 
        <data format="tabular" name="contrib" label="${tool.name}: frogsfunc_functions_pred_metagenome_contrib.tsv" from_work_dir="frogsfunc_functions_pred_metagenome_contrib.tsv">
            <filter>strat</filter>
        </data>
    </outputs>


    <tests>
        <test>
            <param name="input_biom" value="input/FPSteps.biom" />
            <param name="function" value="references/26-frogsfunc_copynumbers_predicted_functions.tsv" />
            <param name="marker" value="references/26-frogsfunc_copynumbers_marker_copy_number.tsv"/>
            <param name="max_nsti" value="2" />
            <param name="min_reads" value="1" />
            <param name="min_samples" value="1" />
            <param name="strat" value="false" />
            <param name="add_description" value="true" />

            <output name="function_abund" file="references/27-frogsfunc_functions_pred_metagenome_unstrat.tsv" compare="diff" lines_diff="0" />
            <output name="seqtab" file="references/27-frogsfunc_functions_seqtab_norm.tsv" compare="diff" lines_diff="0" />
            <output name="weighted" file="references/27-frogsfunc_functions_weighted_nsti.tsv" compare="diff" lines_diff="0" />
            <output name="summary_file" file="references/27-frogsfunc_functions_summary.html" compare="diff" lines_diff="0" />
            <output name="excluded" file="references/27-frogsfunc_functions_excluded.txt" compare="diff" lines_diff="0" />
        </test>
    </tests>

     <help>

@HELP_LOGO@

.. class:: infomark page-header h2

What it does

Predicting of functions weighted by the relative abundance of OTUs in the community. Inferring the metagenomes of the communities with `PICRUSt2 &lt;https://github.com/picrust/picrust2&gt;`_.
There are two steps performed at this stage:
    (i) The read depth per OTU is divided by the predicted marker (16S/ITS/18S) copy numbers. This is performed to help control for variation in marker copy numbers across organisms, which can result in interpretation issues.
        For instance, imagine an organism with five identical copies of the 16S gene that is at the same absolute abundance as an organism with one 16S gene. The OTU corresponding to the first organism would erroneously be inferred to be at higher relative abundance simply because this organism had more copies of the 16S gene.
         
    (ii) The OTU read depths per sample (after normalizing by marker (16S/ITS/18S) copy number) are multiplied by the predicted gene family copy numbers per OTU.         


.. class:: infomark page-header h2

Inputs/Outputs


.. class:: h3

Inputs


**Biom file**:

 The OTUs biom file from FROGSFUNC_step1_placeseqs tool (format `biom1 &lt;http://biom-format.org/documentation/format_versions/biom-1.0.html&gt;`_). (frogsfunc_placeseqs.biom)


**Function file**:

 The table of predicted marker gene copy numbers from FROGSFUNC_step2_copynumbers tool. (frogsfunc_copynumbers_predicted_functions.tsv)

**Marker file**:

 Output table of predicted marker gene copy numbers per sequence from FROGSFUNC_step2_copynumbers tool. (frogsfunc_copynumbers_marker_nsti_predicted.tsv)


**NSTI cut-off**:

 Nearest Sequenced Taxon Index (`NSTI &lt;https://www.nature.com/articles/nbt.2676&gt;`_) is the phylogenetic distance between the OTU and the nearest sequenced reference genome. This metric can be used to identify OTUs that are highly distant from all reference sequences (the predictions for these sequences are less reliable!). The higher the NSTI score, the less the affiliations are relevant. Any OTUs with a NSTI value higher than 2 are typically either from uncharacterized phyla or off-target sequences. 

         
**Do you want to normalise the final output table ?**:

 If stratified option is activate, the abundance predictions are done for each OTU, in order to see the contribution of each OTU within each sample. 

.. image:: static/images/icon_warning_sml.gif 

Warning, the file produced may be heavy.


.. class:: h3

Outputs

**Function abundance file**:
 
 function abundance predictions of metagenome, per sample. (frogsfunc_functions_pred_metagenome_unstrat.tsv)

**Seqtab normalized file**:

 Output file with abundance normalized. (frogsfunc_functions_seqtab_norm.tsv)

**Weighted nsti file**:

 Output file with average nsti calculated per sample. (frogsfunc_functions_weighted_nsti.tsv)

**Contrib per sequences file** (optionnal):

 If stratified option is activated, a new table is built. It represents the contribution of each OTU within each functions (frogsfunc_functions_pred_metagenome_contrib.tsv).

**Summary file**:

.. image:: static/images/FROGS_frogsfunc_functions_piechart.png


OTUs are out if the NSTI associated is above the threshold.

.. image:: static/images/FROGS_frogsfunc_functions_table.png

.. image:: static/images/FROGS_frogsfunc_functions_sunburst.png


Gene families/function from KEGG or Metacyc databases are classified according to 3 hierarchy levels. The graph shows the proportion of each level within the selected samples.

@HELP_CONTACT@

    </help>

    <citations>
        <expand macro="citations" />
    </citations>
    
</tool>
