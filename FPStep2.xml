<?xml version="1.0" encoding="UTF-8"?>
<!--
__author__ = ' Moussa Samb & Maria Bernard  & Geraldine Pascal INRAE - SIGENAE '
__copyright__ = 'Copyright (C) 2020 INRAE'
__license__ = 'GNU General Public License'
__version__ = '1.0'
__email__ = 'frogs@inrae.fr'
__status__ = 'dev'
-->
<tool id="FROGS_PICRUSt2_hsp" name="FPStep2" version= "beta">
	<description>Predict the copy number of gene families present in the predicted genome for each amplicon sequence variant</description>

	<requirements>
               
        
    </requirements>

    <stdio>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>
	

    <command >
	   FPStep2.py
	   		--tree $input_tree
	   		#if $traitsTable.category == "16S"
	   			--in_trait $traitsTable.function
	   		#end if
	   		--hsp_method $hsp_method
	   		--output_marker $out_marker
	   		--output_function $out_function
	   		--debug
	   		#if $traitsTable.category != "16S"
	   		--observed_marker_table ${traitsTable.marker_table.value}
	   		--observed_trait_table ${traitsTable.traits_table.value}
	   		#end if
	</command> 


	<inputs>
	         	 <!-- Files -->
	    <!-- <param format="Fasta" name="fasta_file" type="data" label="Fasta file" help="The sequence file to filter (format: fasta)." /> -->

	    <param format="nhx" name="input_tree" type="data" label="Tree file" help="The full reference tree in newick format containing both study sequences (i.e. ASVs or OTUs) and reference sequences (FPStep1 output)."
	    	optional="false">
        	<validator type="empty_field" message="This parameter is required." />
        </param>

	   			 <!-- Parameters-->
		<conditional name="traitsTable">
	        <param name="category" type="select" label="Taxonomic marker" help="Taxonomic marker of interest." multiple="false" display="radio">
	        	<option value="16S">16S</option>
	        	<option value="other">Other</option>
			</param>
				<when value="16S">
					<param name="function" type="select" label="Function table" help="Note that EC is required for FPStep4." multiple="true" display="checkboxes">
					 <option value="EC" selected="true">EC</option>
		             <option value="KO">KO</option>
		             <option value="PFAM">PFAM</option>
		             <option value="COG">COG</option>
		             <option value="TIGRFAM">TIGRFAM</option>
		             <option value="PHENO">PHENO</option>
					</param>
				</when>
				<when value="other">
				<param name="marker_table" type="select" label="Input marker table.">
					<options from_data_table="picrust2_marker_table">
						        <column name="name" index="2"/>
        						<column name="value" index="2"/>
						<validator type="no_options" message="A built-in database is not available" />
					</options>
				</param>
				<param name="traits_table" type="select" label="Input traits table.">
					<options from_data_table="picrust2_traits_table">
						        <column name="name" index="2"/>
        						<column name="value" index="2"/>
						<validator type="no_options" message="A built-in database is not available" />
					</options>
				</param>
				</when>
		</conditional>

		<param name="hsp_method" type="select" label="HSP method" help='HSP method to use."mp": predict discrete traits usingmax parsimony. "emp_prob": predict discrete traits based on empirical state probabilities across tips. "subtree_average": predict continuous traits using subtree averaging. "pic": predict continuous traits with phylogentic independent contrast. "scp": reconstruct continuous traits using squared-change parsimony (default: mp).' multiple="false" display="radio">
             <option value="mp">mp</option>
             <option value="emp_prob">emp_prob</option>
             <option value="pic">pic</option>
             <option value="scp">scp</option>
             <option value="subtree_average">subtree_average</option>
		</param> 
	</inputs>


	<outputs>
		<data format="tabular" name="out_function" label="${tool.name}: FPStep2_all_predicted.tsv" from_work_dir="FPStep2_all_predicted.tsv"/>
		<data format="tabular" name="out_marker" label="${tool.name}: marker_nsti_predicted.tsv" from_work_dir="${category}_nsti_predicted.tsv"/> 
	</outputs>



     <help>
.. image:: ./static/images/FROGS_logo.png
   :height: 144
   :width: 110

.. class:: infomark page-header h2

What it does

Prediction of functional abundances based solely on the sequences of marker genes with 'PICRUSt2 &lt;https://github.com/picrust/picrust2&gt;`_. 
The second step of Picrust2 consists to predict the family genes of each OTUs constructed elsewhere in a reference phylogenetic tree. 
Give a NST for each OTU with `castor-R &lt;https://cran.r-project.org/web/packages/castor/index.html&gt;``_.


.. class:: infomark page-header h2

Inputs/Outputs

.. class:: h3

Inputs


**OTUs tree**:

**Newick file** (tree.nwk):

The phylogenetic tree of insert sequences (FPStep 1 output, FPStep1.tree) (format `nxh &lt;https://en.wikipedia.org/wiki/Newick_format&gt;`_).

**OTUs biom file**:

The OTUs biom file (format `biom1 &lt;http://biom-format.org/documentation/format_versions/biom-1.0.html&gt;`_).
This file can be obtained in particular with the FROGS pipeline.

**Table of prediction **:

If the genetic marker studied is 16S RNA gene:
Which default pre-calculated count table to use (one of 'COG', 'EC', 'KO', 'PFAM', 'TIGRFAM', 'PHENO')

** Observed marker table **:

If the genetic marker studied is not 16S RNA gene:
Please specified input marker table describing directly observed traits.

** Observed trait table **:

If the genetic marker studied is not 16S RNA gene:
Please specified input function table describing directly observed traits.
.. class:: h3

Outputs

** Output marker file **:

Output table of predicted marker gene copy numbers per study sequence in input tree. (FPStep2_marker_nsti_predicted.tsv)

** Output function file **:

Output table with predicted abundances per study sequence in input tree. (FPStep2_all_predicted.tsv)

.. class:: infomark page-header h2

**Contact**

Contacts: frogs@inra.fr

website: http://frogs.toulouse.inra.fr/

Repository: https://github.com/geraldinepascal/FROGS
website: http://frogs.toulouse.inra.fr/

Please cite the **FROGS article**: *Escudie F., et al. Bioinformatics, 2018. FROGS: Find, Rapidly, OTUs with Galaxy Solution.*

Please cite the	**PICRUSt2 article**: * Gavin M. Douglas1, Vincent J. Maffei2, Jesse Zaneveld3, Svetlana N. Yurgel4, James R. Brown5, Christopher M. Taylor2, Curtis Huttenhower6, Morgan G. I. Langille1,7,*	

     </help>

    <citation>
    	<citation type="doi">10.1101/672295</citation>
 	</citation>
 </tool>
