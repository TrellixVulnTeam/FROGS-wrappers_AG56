<!DOCTYPE html>
<!--
# Copyright (C) 2015 INRA
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
    <head>
        <title>FROGS Pre-process</title>
        <meta charset="UTF-8">
        <meta name="version" content="1.2.1">
        <!-- CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.10.6/css/jquery.dataTables.css"></link>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"></link>
        <style type="text/css">
            #js-alert {
                width: 90%;
                margin-right: auto;
                margin-left: auto;
            }
            #content {
                width: 90%;
                margin-right: auto;
                margin-left: auto;
            }
            .clear {
                clear: both;
                height: 0px;
                width: 100%;
                float: none !important;
            }
        </style>
        <!-- JS -->
        <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script type="text/javascript" src="http://code.highcharts.com/4.1.4/highcharts.js"></script>
        <script type="text/javascript" src="http://code.highcharts.com/4.1.4/modules/exporting.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            /*
             * HTMLTable.js 0.1.0 - HTMLTable Library
             *
             * Copyright (c) 2015 Escudie Frederic
             * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
             */
            function HTMLtable(e){var t,r,n=e,a=";";this.deleteColumns=function(e){for(var a=n.getElementsByTagName("tr"),o=0;o<a.length;o++){s=0;var i=a[o].getElementsByTagName("td");0==i.length&&(i=a[o].getElementsByTagName("th"));for(var v=0,s=0;s<t[1];s++)if(!r[o][s]){var f=i[v].getAttribute("colspan");if(null!=f)for(var m=0;f>m;m++){if(in_array(s+m,e)){var u=i[v].getAttribute("colspan");u-1==0?i[v].removeAttribute("colspan"):i[v].setAttribute("colspan",u-1)}if(null==i[v].getAttribute("colspan")){var h=i[v];a[o].removeChild(h),v--}}else if(in_array(s,e)){var h=i[v];a[o].removeChild(h),v--}v++}}l(),g()},this.filter=function(e,a){var l=new RegExp(e),g=new Array;null!=a&&a||(g.c0=!0);for(var o=n.getElementsByTagName("tr"),i=0;i<o.length;i++){f=0;var v=o[i].getElementsByTagName("td");if(0!=v.length)for(var s=0,f=0;f<t[1];f++)r[i][f]||(l.test(v[s].innerHTML)&&(g["c"+f]=!0),s++)}for(var m=new Array,u=0;u<t[1];u++)void 0===g["c"+u]&&m.push(u);this.deleteColumns(m)},this.getModel=function(){return n};var l=function(){for(var e=0,r=0,a=n.getElementsByTagName("tr"),l=0;l<a.length;l++){var g=0;e++;var o=a[l].getElementsByTagName("td");0==o.length&&(o=a[l].getElementsByTagName("th"));for(var i=0;i<o.length;i++){var v=o[i].getAttribute("colspan");g+=null==v?1:parseInt(v)}g>r&&(r=g)}t=new Array(2),t[0]=e,t[1]=r},g=function(){r=new Array(t[0]);for(var e=0;e<t[0];e++){r[e]=new Array(t[1]);for(var a=0;a<t[1];a++)r[e][a]=!1}for(var l=n.getElementsByTagName("tr"),g=0;g<l.length;g++){v=0;var o=l[g].getElementsByTagName("td");0==o.length&&(o=l[g].getElementsByTagName("th"));for(var i=0,v=0;v<t[1];v++)if(!r[g][v]){var s=0,f=0,m=o[i].getAttribute("rowspan");null!=m&&(s=parseInt(m)-1);var u=o[i].getAttribute("colspan");null!=u&&(f=parseInt(u)-1);for(var h=s;h>=0;h--)for(var y=f;y>=0;y--)(0!=h||0!=y)&&(r[g+h][v+y]=!0);i++}}};this.replace=function(e,a,l){var g=new RegExp(e);null==a&&(a=""),null==l&&(l="");for(var o=n.getElementsByTagName("tr"),i=0;i<o.length;i++){f=0;var v=o[i].getElementsByTagName("td");if(0!=v.length)for(var s=0,f=0;f<t[1];f++)if(!r[i][f]){var m=g.exec(v[s].innerHTML);null!=m&&(void 0===m[1]&&(m[1]=""),v[s].innerHTML=a+m[1]+l),s++}}},this.toCSV=function(){for(var e="",l=n.getElementsByTagName("tr"),g=0;g<l.length;g++){var o=l[g].getElementsByTagName("td");0==o.length&&(o=l[g].getElementsByTagName("th"));for(var i=0,v=0;v<t[1];v++)r[g][v]||(e+=o[i].innerHTML,i++),e+=a;e=e.substr(0,e.length-1)+"\n"}return e},l(),g()}var in_array=function(e,t){for(var r in t)if(t[r]==e)return!0;return!1};
            
            /*
             * dataTableExtractor.plugin.js 0.1.0 - datatableExport Library
             *
             * Copyright (c) 2015 Escudie Frederic
             * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
             */
            !function(t){t.fn.datatableExport=function(a){var e={anchor_id:t(this).attr("id"),table_id:null,csv_separator:";",omitted_columns:[]},n=t.extend(e,a);if(!t(this).length)throw"The element where the datatableExport is called does not exist.";if(void 0==n.anchor_id)throw"The datatableExport plugin must be called on an element with id.";if(null==n.table_id)throw"You must set the table_id parameter in datatableExport plugin.";if(!t("#"+n.table_id))throw"The datatable '#"+n.table_id+"' cannot be retieve in DOM.";return this.each(function(){var a=t(this);a.on("click",function(){t.fn.datatableExport.csv(n.anchor_id,n.table_id,n.csv_separator,n.omitted_columns)})})},t.fn.datatableExport.cleanCellMarkup=function(a,e){t.parseHTML(e);t("#"+a).append('<div class="hidden data-tmp">'+e+"</div>"),t("#"+a+" .data-tmp").find("input").each(function(){var a="";a=t(this).is(":checkbox")?t(this).is(":checked")?"true":"false":t(this).val(),t(this).replaceWith(a)});var n=t("#"+a+" .data-tmp").text();return t("#"+a+" .data-tmp").remove(),n},t.fn.datatableExport.csv=function(a,e,n,i){var l="",r=t("#"+e).DataTable(),d=t("#"+e+" thead")[0],o=new HTMLtable(d.cloneNode(!0));o.deleteColumns(i),l+=o.toCSV();var c=r.rows().data();t.each(c,function(e,n){for(var r="",d=0;d<n.length;d++)-1==t.inArray(d,i)&&(r+='"'+t.fn.datatableExport.cleanCellMarkup(a,n[d])+'";');""!=r&&(r=r.slice(0,-1)),l+=r+"\n"}),t("#"+a+"-extract-csv").length||t("#"+a).append('<a id="'+a+'-extract-csv" href="data:text/csv;charset=UTF-8,'+encodeURI(l)+'" download="data.csv" style="display:none;"></a>'),t("#"+a+"-extract-csv")[0].click()}}(jQuery);
        </script>
        <script type="text/javascript">
            /**
             * Returns the string representation of the number. 
             * @param pValue {Float} The number to process.
             * @return {String} The string representation (example: 12856892.11111 => 12,856,892.11).
             */
            var numberDisplay = function( pValue ){
                var new_val = "" ;
                if( ("" + pValue + "").indexOf(".") != -1 ){
                    new_val = pValue.toFixed(2).replace(/(\d)(?=(\d{3})+\b)/g, '$1,');
                } else {
                    new_val = pValue.toFixed().replace(/(\d)(?=(\d{3})+\b)/g, '$1,');
                }
                return new_val ;
            }
            
            /**
             * Returns hash use to init HightChart line. 
             * @param pTitle {String} The title of the chart.
             * @param pXTitle {String} The xAxis title.
             * @param pYTitle {String} The yAxis title.
             * @param pXCategories {Array} x scale labels.
             * @param pData {Array} The HightChart series.
             * @return {Hash} Parameters to use in Highchart's constructor.
             */
            var lineplot_param = function(pTitle, pXTitle, pYTitle, pXCategories, pData) {
                return {
                    chart: {
                        type: 'line',
                        zoomType: 'x'
                    },
                    title: {
                        text: pTitle
                    },
                    xAxis: {
                        title: {
                            text: pXTitle
                        }
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: pYTitle
                        }
                    },
                    series: pData,
                    tooltip: {
                        formatter:function() {
                            tooltip_head = '<b>Length ' + this.x + 'nt</b>' ;
                            tooltip_body = '' ;
                            for( var i=0 ; i<this.points.length ; i++) {
                                tooltip_body += '' +
                                    '<tr>' +
                                    '    <td style="color:' + this.points[i].series.color +'">' + this.points[i].series.name + ': </td>' +
                                    '    <td> ' + numberDisplay(this.points[i].point.y) + ' </td>' +
                                    '    <td> seq</td>' +
                                    '</tr>' ;
                            }
                            return tooltip_head + '<table>' + tooltip_body + '</table>' ;
                        },
                        shared: true,
                        useHTML: true
                    },
                    legend: {
                        enabled: true
                    },
                    credits: {
                        enabled: false
                    }
                };
            }

            /**
             * Returns hash use to init HightChart column. 
             * @param pTitle {String} The title of the chart.
             * @param pYTitle {String} The yAxis title.
             * @param pCategories {Array} x scale labels.
             * @param pSeries {Array} The HightChart series.
             * @param unity {String} Unity used in tooltip.
             * @return {Hash} Parameters to use in Highchart's constructor.
             */           
            var histogram_param = function( pTitle, pYTitle, pCategories, pSeries, unity ) {
                var param = {
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: pTitle
                    },
                    xAxis: {
                        categories: pCategories,
                        crosshair: true
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: pYTitle
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                            '<td style="padding:0"><b>{point.y} ' + unity + '</b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    credits: {
                        enabled: false
                    },
                    series: pSeries
                };
                
                return param ;
            }
            
            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            //
            // Data
            //
            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            var filters_categories = ["before process", "paired-end assembled", "with 5' primer", "with 3' primer", "with expected length", "without N"] ;
            /* Example:
                ["before process", "overlapped", "with expected length", "with 5' primer", "with 3' primer", "with expected length", "without N"]
            */
            var filters_by_sample = {"before process": {"splA_01": 88684, "splA_02": 54167, "splA_03": 32386}, "merged": {"splA_01": {"with expected length": 80630, "with 3' primer": 81066, "with 5' primer": 81330, "without N": 80630, "paired-end assembled": 84836}, "splA_02": {"with expected length": 48917, "with 3' primer": 49239, "with 5' primer": 49390, "without N": 48917, "paired-end assembled": 51925}, "splA_03": {"with expected length": 29304, "with 3' primer": 29476, "with 5' primer": 29573, "without N": 29304, "paired-end assembled": 31079}}} ;
            /* Example:
                {
                  "sampleA": [90126, 90126, 90126, 89697, 89697, 89697, 89697],
                  "sampleB": [213043, 209801, 0, 0, 0, 0, 0] 
                }
            */
             var before_lengths_by_sample = {"splA_01": {"407": 2146, "406": 1042, "405": 1272, "404": 959, "340": 33, "402": 986, "401": 487, "400": 374, "281": 2, "280": 3, "283": 3, "282": 4, "348": 33, "349": 30, "409": 2984, "408": 3026, "336": 46, "440": 245, "331": 27, "330": 17, "263": 4, "421": 3253, "261": 6, "260": 1, "267": 9, "456": 14, "265": 10, "264": 2, "269": 4, "268": 2, "423": 3012, "422": 1327, "425": 5255, "424": 2313, "414": 442, "378": 64, "416": 386, "417": 150, "410": 688, "411": 249, "412": 493, "413": 468, "371": 30, "370": 27, "373": 30, "372": 27, "418": 216, "419": 424, "377": 33, "376": 28, "319": 25, "318": 47, "313": 116, "312": 55, "311": 12, "310": 9, "317": 15, "316": 18, "315": 17, "314": 12, "393": 4962, "392": 1901, "391": 1388, "390": 1728, "397": 127, "396": 158, "395": 298, "394": 2709, "278": 3, "279": 4, "399": 240, "398": 228, "457": 11, "379": 20, "415": 756, "256": 2, "429": 1490, "428": 1627, "447": 6085, "368": 46, "369": 29, "366": 33, "367": 58, "364": 27, "365": 33, "362": 23, "363": 44, "427": 5947, "426": 2041, "308": 12, "309": 11, "449": 50, "448": 176, "298": 7, "300": 3, "301": 6, "302": 4, "303": 7, "304": 11, "305": 19, "445": 2283, "446": 2133, "380": 27, "381": 36, "382": 55, "383": 40, "384": 34, "385": 35, "386": 56, "387": 374, "388": 1457, "389": 2724, "443": 246, "444": 756, "294": 2, "306": 10, "295": 3, "360": 35, "296": 2, "420": 506, "374": 26, "290": 3, "438": 328, "439": 294, "436": 382, "437": 360, "434": 750, "299": 8, "432": 431, "433": 1101, "307": 7, "431": 670, "458": 29, "459": 16, "339": 25, "338": 55, "335": 63, "334": 34, "452": 14, "453": 13, "454": 18, "455": 11, "333": 32, "332": 20, "258": 3, "259": 3, "252": 3, "442": 160, "251": 2, "253": 4, "257": 3, "254": 3, "255": 2, "289": 2, "288": 4, "346": 28, "347": 27, "297": 7, "403": 1239, "341": 22, "342": 27, "343": 29, "460": 15, "344": 24, "270": 3, "271": 5, "285": 1, "272": 2, "284": 3, "273": 3, "287": 2, "274": 2, "286": 3, "275": 2, "276": 5, "277": 2, "361": 22, "292": 6, "375": 29, "355": 29, "441": 580, "322": 12, "323": 23, "320": 17, "321": 23, "326": 18, "327": 22, "324": 24, "325": 21, "328": 27, "329": 19, "352": 18, "450": 14, "293": 3, "435": 274, "262": 2, "291": 2, "451": 19, "357": 49, "356": 36, "345": 27, "354": 29, "353": 23, "430": 833, "351": 37, "350": 17, "337": 31, "358": 38, "359": 29, "266": 3}, "splA_02": {"407": 1195, "406": 641, "405": 707, "404": 636, "340": 19, "402": 671, "342": 19, "400": 255, "281": 5, "280": 5, "283": 2, "282": 6, "348": 23, "284": 5, "287": 5, "408": 1702, "336": 27, "440": 126, "331": 22, "330": 19, "263": 4, "421": 2280, "261": 6, "260": 6, "267": 11, "266": 3, "265": 7, "264": 5, "269": 5, "268": 5, "423": 1868, "365": 31, "425": 2750, "424": 1309, "414": 283, "378": 52, "416": 307, "417": 88, "410": 502, "411": 170, "412": 312, "413": 334, "371": 16, "370": 17, "294": 8, "295": 8, "418": 176, "419": 326, "290": 7, "376": 15, "319": 20, "318": 37, "313": 70, "312": 51, "311": 12, "310": 10, "317": 20, "316": 15, "315": 10, "314": 13, "393": 2840, "392": 1168, "391": 811, "390": 898, "397": 94, "396": 115, "395": 169, "277": 8, "278": 1, "279": 3, "399": 156, "398": 199, "379": 17, "415": 537, "256": 5, "429": 1054, "428": 1015, "447": 3590, "368": 18, "369": 18, "366": 31, "367": 31, "364": 31, "422": 735, "362": 12, "363": 34, "427": 3756, "426": 1256, "308": 13, "309": 6, "449": 40, "448": 118, "298": 4, "300": 6, "301": 2, "302": 9, "303": 5, "304": 9, "305": 11, "445": 1374, "446": 1344, "380": 14, "381": 11, "382": 26, "383": 22, "384": 13, "385": 20, "386": 33, "387": 163, "388": 829, "389": 1501, "443": 165, "444": 450, "373": 13, "306": 10, "333": 23, "372": 18, "360": 15, "296": 4, "420": 370, "374": 16, "377": 30, "438": 229, "439": 185, "436": 207, "437": 239, "434": 452, "299": 6, "432": 311, "433": 728, "307": 3, "431": 442, "458": 13, "459": 6, "339": 24, "338": 30, "335": 35, "334": 31, "452": 5, "453": 6, "454": 4, "455": 9, "456": 12, "457": 8, "258": 5, "259": 2, "252": 3, "442": 116, "251": 4, "253": 4, "257": 9, "254": 1, "255": 5, "344": 24, "288": 1, "346": 21, "347": 16, "297": 3, "403": 857, "341": 20, "401": 327, "343": 15, "460": 5, "289": 9, "270": 6, "271": 6, "285": 1, "272": 5, "349": 19, "273": 4, "409": 1780, "332": 14, "274": 3, "286": 7, "275": 5, "276": 3, "394": 1542, "361": 8, "292": 5, "375": 20, "355": 20, "441": 355, "322": 18, "323": 16, "320": 10, "321": 9, "326": 15, "327": 19, "324": 12, "325": 18, "328": 25, "329": 13, "352": 19, "450": 15, "293": 4, "435": 213, "262": 5, "291": 6, "451": 9, "357": 38, "356": 18, "345": 18, "354": 17, "353": 23, "430": 507, "351": 23, "350": 10, "337": 26, "359": 17, "358": 19}, "splA_03": {"407": 730, "406": 373, "405": 445, "404": 361, "340": 12, "402": 354, "401": 182, "400": 144, "281": 3, "280": 2, "283": 1, "282": 1, "348": 17, "349": 12, "409": 1111, "408": 1088, "336": 19, "440": 92, "331": 12, "330": 7, "263": 2, "421": 1206, "261": 2, "260": 1, "267": 4, "456": 5, "265": 2, "264": 3, "269": 4, "268": 1, "423": 1115, "422": 466, "425": 1859, "424": 775, "414": 172, "378": 27, "416": 165, "417": 57, "410": 267, "411": 89, "412": 196, "413": 187, "371": 13, "370": 10, "373": 17, "372": 10, "418": 97, "419": 167, "377": 10, "376": 13, "319": 8, "318": 15, "313": 53, "312": 21, "311": 8, "310": 3, "317": 5, "316": 5, "315": 7, "314": 7, "393": 1739, "392": 741, "391": 500, "390": 636, "397": 44, "396": 64, "395": 114, "394": 1022, "278": 3, "279": 2, "399": 104, "398": 83, "457": 7, "379": 10, "415": 270, "256": 4, "429": 607, "428": 595, "447": 2139, "368": 11, "369": 9, "366": 19, "367": 19, "364": 14, "365": 12, "362": 9, "363": 16, "427": 2140, "426": 714, "308": 10, "309": 3, "449": 16, "448": 69, "298": 3, "300": 2, "301": 3, "302": 3, "303": 3, "304": 6, "305": 11, "445": 858, "446": 803, "380": 9, "381": 16, "382": 12, "383": 15, "384": 14, "385": 13, "386": 22, "387": 111, "388": 471, "389": 972, "443": 92, "444": 269, "294": 6, "306": 3, "295": 2, "360": 14, "296": 1, "420": 188, "374": 13, "290": 2, "438": 144, "439": 102, "436": 135, "437": 133, "434": 271, "435": 110, "432": 172, "433": 382, "307": 3, "431": 277, "458": 11, "459": 6, "339": 14, "338": 28, "335": 21, "334": 17, "452": 5, "453": 3, "454": 8, "455": 3, "333": 18, "332": 7, "258": 1, "259": 1, "252": 3, "442": 64, "253": 4, "257": 4, "255": 2, "289": 3, "288": 1, "346": 14, "347": 11, "403": 474, "341": 7, "342": 9, "343": 11, "460": 5, "344": 7, "270": 4, "271": 5, "285": 1, "272": 2, "284": 4, "273": 3, "287": 1, "274": 1, "286": 3, "275": 2, "276": 3, "277": 4, "361": 2, "292": 3, "375": 11, "355": 12, "441": 241, "322": 6, "323": 11, "320": 10, "321": 8, "326": 7, "327": 7, "324": 9, "325": 8, "328": 15, "329": 4, "352": 9, "450": 7, "293": 4, "262": 2, "291": 6, "451": 6, "357": 20, "356": 15, "345": 13, "354": 12, "353": 10, "430": 317, "351": 15, "350": 5, "337": 13, "358": 15, "359": 9, "266": 1}} ;
            /* Example:
                {
                  "sampleA": {"395": 1, "381": 192, "382": 1790, "383": 2903, "384": 1078, "385": 10536, "386": 18182, "387": 8613, "388": 1097, "389": 7},
                  "sampleB": {}
                }
            */

            var after_lengths_by_sample = {"splA_01": {"357": 1707, "387": 304, "375": 3005, "393": 1723, "392": 5450, "391": 2070, "390": 3023, "397": 818, "396": 1494, "395": 1622, "394": 6216, "413": 1843, "399": 367, "398": 658, "354": 255, "379": 477, "374": 2047, "415": 143, "412": 2260, "355": 1348, "407": 208, "406": 288, "405": 306, "347": 5, "403": 366, "402": 267, "401": 751, "369": 951, "366": 195, "367": 347, "423": 3, "365": 213, "348": 11, "363": 142, "360": 5113, "426": 5, "410": 206, "425": 12, "368": 442, "356": 2790, "400": 1110, "370": 1231, "380": 462, "381": 398, "382": 768, "383": 375, "384": 122, "385": 192, "386": 403, "420": 3, "388": 3336, "389": 1202, "409": 132, "364": 116, "411": 596, "376": 3076, "372": 1239, "359": 1642, "362": 287, "404": 352, "349": 28, "414": 6477, "378": 199, "416": 44, "417": 8, "353": 10, "352": 4, "351": 8, "350": 7, "371": 926, "408": 590, "373": 980, "361": 2820, "418": 8, "419": 4, "377": 700, "358": 1324}, "splA_02": {"372": 694, "379": 302, "354": 103, "361": 1624, "375": 1664, "393": 1070, "392": 2835, "391": 1196, "390": 1882, "397": 507, "396": 1056, "395": 1005, "394": 3915, "413": 1195, "399": 277, "398": 420, "378": 152, "414": 3806, "374": 1166, "415": 101, "355": 788, "407": 112, "406": 183, "405": 227, "347": 3, "403": 209, "402": 196, "401": 454, "400": 742, "366": 141, "367": 222, "364": 85, "365": 182, "348": 1, "363": 103, "360": 2922, "426": 2, "410": 138, "425": 4, "368": 306, "369": 652, "380": 326, "381": 259, "382": 528, "383": 306, "384": 75, "385": 150, "386": 283, "387": 222, "388": 2378, "389": 632, "409": 100, "423": 4, "411": 372, "376": 1853, "377": 487, "422": 1, "362": 148, "404": 219, "349": 15, "357": 894, "356": 1490, "416": 31, "417": 9, "353": 8, "352": 4, "412": 1327, "350": 1, "371": 604, "370": 845, "373": 588, "408": 360, "418": 4, "419": 1, "359": 1021, "358": 730}, "splA_03": {"357": 624, "387": 120, "375": 1070, "393": 634, "392": 1909, "391": 706, "390": 1104, "397": 324, "396": 589, "395": 596, "394": 2213, "399": 146, "398": 261, "354": 64, "379": 190, "374": 699, "415": 55, "412": 832, "355": 439, "407": 81, "406": 102, "405": 138, "347": 1, "403": 137, "402": 100, "401": 269, "369": 340, "366": 86, "367": 128, "423": 1, "365": 80, "348": 4, "363": 51, "360": 1812, "426": 2, "410": 81, "425": 4, "368": 171, "356": 976, "400": 390, "370": 471, "380": 183, "381": 162, "382": 266, "383": 154, "384": 50, "385": 79, "386": 155, "420": 1, "388": 1242, "389": 416, "409": 53, "364": 44, "411": 217, "376": 1142, "372": 440, "359": 634, "362": 116, "404": 123, "349": 5, "414": 2289, "378": 68, "416": 13, "417": 4, "353": 2, "352": 1, "351": 4, "413": 704, "371": 353, "408": 242, "373": 346, "361": 1050, "418": 1, "419": 2, "377": 268, "358": 475}} ;
            /* Example:
                {
                  "sampleA": {"395": 1, "381": 192, "382": 1790, "383": 2903, "384": 1078, "385": 10536, "386": 18182, "387": 8613, "388": 1097, "389": 7},
                  "sampleB": {}
                }
            */
            
            
            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            //
            // Main
            //
            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            /**
             * Disables/enables buttons in datatable.
             */
            var updateButtonState = function(){
                $("#display-spl-lengths").removeClass( "disabled" );
                if( $('input[id^="filterBySample-chk-"]:checked').length == 0 ){
                    $("#display-spl-lengths").addClass( "disabled" );
                }
                $("#display-after-spl-lengths").removeClass( "disabled" );
                if( $('input[id^="filterBySample-chk-"]:checked').length == 0 ){
                    $("#display-after-spl-lengths").addClass( "disabled" );
                }
            }
            
            /**
             * Draws for the selected sample(s) the line chart that represents the number of sequences by sequence length. 
             */
            var setLengthsGraph = function(lengths_by_sample,title){ 
                var selected_series = new Array();
                $('input[id^="filterBySample-chk-"]').each( function(){
                    if( $(this).is(':checked')){
                        var sample_name = $(this).prop('id').substring(19, $(this).prop('id').length) ;
                        // Find min and max for the sample
                        var min_length = null ;
                        var max_length = null ;
                        for(seq_length in lengths_by_sample[sample_name]){
                            if( max_length === null ){
                                min_length = parseInt(seq_length) ;
                                max_length = parseInt(seq_length) ;
                            } else {
                                min_length = Math.min( min_length, parseInt(seq_length) );
                                max_length = Math.max( max_length, parseInt(seq_length) );
                            }
                        }
                        // Complete data
                        var sample_data = new Array();
                        if( max_length !== null ){
                            for( var curr_length = min_length ; curr_length <= max_length ; curr_length++ ){
                                if( lengths_by_sample[sample_name].hasOwnProperty(curr_length.toString()) ){
                                    sample_data.push([
                                        curr_length,
                                        lengths_by_sample[sample_name][curr_length.toString()]
                                    ]);
                                } else {
                                    sample_data.push( [curr_length, null] );
                                }
                            }
                        }
                        // Add serie
                        selected_series.push({
                            "name": sample_name,
                            "data": sample_data
                        });
                    }
                });
                // Draw chart
                $('#lengths-chart').highcharts( lineplot_param(title, "Length", "Nb sequences", null, selected_series) );
            }
            
            /**
             * Draws the bar chart that represents the total number of sequences after each filter. 
             */
            var summaryLoad = function(){
                var global_data = new Array();
                for( var spl_name in filters_by_sample ){
                    var nb_by_step = filters_by_sample[spl_name] ;
                    for( var step_idx = 0 ; step_idx < filters_by_sample[spl_name].length ; step_idx++ ){
                        if( global_data.length < step_idx+1 ){
                            global_data.push(0);
                        }
                        global_data[step_idx] += nb_by_step[step_idx] ;
                    }
                }
                var global_series = [{ name: 'All samples', data: global_data }];
                $('#filter-summary').highcharts( histogram_param('Filtering summary', 'Nb sequences', filters_categories, global_series, 'seq') );
            }

            /**
             * Set the table that represents by sample the number of sequences after each filter. 
             */
            var sampleDetailsLoad = function(){
                // Table titles
                var titles = [ '<input id="filterBySample-check-all" type="checkbox" value="1">', "Samples" ];
                titles.push( '% kept' );
                for( var rank = 0 ; rank < filters_categories.length ; rank++ ){
                    titles.push( filters_categories[rank] );
                }
                $('#filterBySample-table thead').append( '<tr><th>' + titles.join("</th><th>") + '</th></tr>' );
                $('#filterBySample-table .title').attr( "colspan", titles.length );
                $('#filterBySample-table tfoot th').each(function(){
                    $(this).attr( "colspan", titles.length );
                });
                
                // Table data
                for( var sample_name in filters_by_sample ){
                    var sample_data = ['<input id="filterBySample-chk-' + sample_name + '" type="checkbox" value="1">', sample_name] ;
                    var prct_kept = filters_by_sample[sample_name][filters_categories.length-1]/filters_by_sample[sample_name][0]*100
                    sample_data.push( numberDisplay(prct_kept) );
                    for( var idx = 0 ; idx < filters_by_sample[sample_name].length ; idx++){
                        sample_data.push( numberDisplay(filters_by_sample[sample_name][idx]) );
                    }
                    // Add row data
                    $('#filterBySample-table tbody').append( '<tr><td>' + sample_data.join("</td><td>") + '</td></tr>' );
                }
                
                // Check all management
                $('#filterBySample-check-all').on('change', function (e) { // Manage check all
                    if( $(this).is(':checked') ){
                        $('input[id^="filterBySample-chk-"]').each( function(){
                            $(this).prop( 'checked', true );
                        });
                    } else {
                        $('input[id^="filterBySample-chk-"]').each( function(){
                            $(this).prop( 'checked', false );
                        });
                    }
                });
                $('input[id^="filterBySample-chk-"]').on('change', function (e) { // Uncheck select all when uncheck one sample
                    if( !$(this).is(':checked') && $('#filterBySample-check-all').is(':checked') ){
                        $('#filterBySample-check-all').prop( 'checked', false );
                    }
                });
                
                // Buttons enable/disable management
                $('input[id^="filterBySample-check-all"]').on( 'change', updateButtonState );
                $('input[id^="filterBySample-chk-"]').on( 'change', updateButtonState );
                
                // Datatable
                $('#filterBySample-table').DataTable({
                    "sDom": '<"top"<"#filterBySample-csv-export"><"clear">lf>rt<"bottom"ip><"clear">',
                    'order': [[1, 'asc']],
                    'columnDefs': [{
                        'targets': [0],
                        'orderable': false
                    }],
                    "fnDrawCallback": updateButtonState
                });
                // Datatable export
                $('#filterBySample-csv-export').html( '<button class="btn btn-primary"><span class="glyphicon glyphicon-open-file" aria-hidden="true">CSV</span></button>' );
                $('#filterBySample-csv-export').addClass( 'dataTables_filter' );
                $('#filterBySample-csv-export').datatableExport({
                    'table_id': "filterBySample-table",
                    'omitted_columns': [0]
                });

                // Add modal listener
                $('#lengths-modal').on('shown.bs.modal', function (event) {
                    var button = $(event.relatedTarget); // Button that triggered the modal
                    var data_type = button.data('whatever');
                    if( data_type == "before-process" ){
                        setLengthsGraph(before_lengths_by_sample,"Amplicon length distribution before trimming and filtering");
                    } else {
                        setLengthsGraph(after_lengths_by_sample,"Preprocessed Amplicon Length distribution");
                    }
                });
            }

            $(function() {
                // Remove alert
                $('#js-alert').remove();
                $('#content').removeClass("hidden");
                
                // Display summary
                summaryLoad();
                
                // Display data by sample
                sampleDetailsLoad();
            });
        </script>
    </head>
    <body>
        <!-- Alert -->
        <p id="js-alert" class="alert alert-warning">
            javascript is needed to display data.<br />
            If you try to view this data on galaxy please contact your administrator to authorise javascript or download the file to view.
        </p>
        
        <!-- Content -->
        <div id="content" class="hidden">
            <div id="filter-summary"></div>
            <div id="filter-log">
                <table id="filterBySample-table" class="table table-striped">
                    <thead>
                        <tr>
                            <th class="title">Filtering by sample</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <th>
                                <span class="table-action">With selection:</span>
                                <button id="display-spl-lengths" class="btn btn-primary table-action fusion-right disabled" data-toggle="modal" data-target="#lengths-modal" data-whatever="before-process">Display amplicon lengths </button>
                                <button id="display-after-spl-lengths" class="btn btn-primary table-action disabled" data-toggle="modal" data-target="#lengths-modal" data-whatever="after-process">Display preprocessed amplicon lengths</button>
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Modals -->
        <div class="modal" id="lengths-modal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Amplicons lengths</h4>
                    </div>
                    <div class="modal-body">
                        <div id="lengths-chart"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
